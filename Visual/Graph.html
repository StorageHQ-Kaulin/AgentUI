<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Architecture Graph</title>
    <style>
        :root {
            --bg-color: #0b0d10;
            --panel-bg: rgba(16, 20, 24, 0.95);
            --accent-color: #00ffcc;
            --accent-warn: #ffaa00;
            --accent-error: #ff4444;
            --text-color: #e0e0e0;
            --border-color: #333;
            --font-mono: 'Consolas', 'Monaco', monospace;
            --font-main: 'Segoe UI', sans-serif;

            /* File Type Colors */
            --color-schema: #f1c40f;
            --color-auth: #e74c3c;
            --color-api: #3498db;
            --color-data: #2ecc71;
            --color-log: #95a5a6;
        }

        body {
            margin: 0;
            overflow: hidden;
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        #app-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        /* Graph Canvas */
        #view-graph {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(#222 1px, transparent 1px);
            background-size: 20px 20px;
            cursor: grab;
            overflow: hidden;
        }

        #view-graph:active {
            cursor: grabbing;
        }

        #graph-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform-origin: 0 0;
        }

        /* Nodes */
        .node {
            position: absolute;
            width: 140px;
            background: #111;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 10px;
            font-size: 12px;
            color: #ccc;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            z-index: 2;
            cursor: pointer;
            transition: transform 0.1s, border-color 0.2s;
            user-select: none;
        }

        .node:hover {
            border-color: #666;
            transform: translateY(-2px);
        }

        .node.root {
            border-color: var(--accent-color);
            color: white;
            font-weight: bold;
        }

        .node.selected {
            border-color: var(--accent-warn);
            box-shadow: 0 0 15px rgba(255, 170, 0, 0.3);
            z-index: 10;
        }

        .node-label {
            display: block;
            margin-bottom: 4px;
        }

        .node-status {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
        }

        /* Agent Badge */
        .node-agent {
            position: absolute;
            bottom: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: var(--accent-color);
            color: #000;
            border-radius: 50%;
            font-size: 9px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            z-index: 3;
        }

        /* Connections */
        svg.connections {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: visible;
        }

        path.edge {
            fill: none;
            stroke-width: 2px;
            transition: stroke 0.2s;
        }

        /* Edge Labels */
        .edge-label-group {
            cursor: pointer;
            pointer-events: auto;
        }

        .edge-label-group:hover rect {
            stroke: white;
            stroke-width: 2px;
        }

        .edge-label-bg {
            rx: 4;
            stroke: #333;
            stroke-width: 1px;
        }

        .edge-label-text {
            font-family: var(--font-mono);
            font-size: 10px;
            text-anchor: middle;
            pointer-events: none;
            fill: #eee;
            font-weight: bold;
        }

        /* Legend */
        .graph-legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(16, 20, 24, 0.9);
            border: 1px solid #333;
            padding: 10px;
            border-radius: 4px;
            pointer-events: none;
            font-family: var(--font-mono);
            font-size: 11px;
            color: #ccc;
            z-index: 10;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .legend-color {
            width: 12px;
            height: 2px;
            margin-right: 8px;
        }

        /* Detail Panel */
        #detail-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 340px;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-left: 3px solid var(--accent-color);
            border-radius: 4px;
            display: none;
            z-index: 20;
            box-shadow: -10px 10px 30px rgba(0, 0, 0, 0.5);
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .panel-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.02);
        }

        .panel-title {
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .panel-close {
            cursor: pointer;
            color: #666;
            font-size: 18px;
        }

        .panel-close:hover {
            color: white;
        }

        .panel-content {
            padding: 15px;
            font-size: 13px;
        }

        .prop-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .prop-label {
            color: #888;
        }

        .prop-val {
            color: white;
            font-family: var(--font-mono);
            text-align: right;
        }

        /* File Preview */
        .file-preview {
            background: #050505;
            border: 1px solid #333;
            padding: 10px;
            font-family: var(--font-mono);
            font-size: 10px;
            color: #aaa;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 200px;
            border-radius: 4px;
            margin-top: 5px;
        }

        /* Lists & Trees */
        .subtask-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }

        .subtask-item {
            padding: 8px;
            border-bottom: 1px solid #222;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 3px;
        }

        .subtask-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            background: #333;
        }

        .file-tree-container {
            background: #080808;
            border: 1px solid #222;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .file-attach-form {
            margin-top: 10px;
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .file-attach-input {
            flex: 1;
            padding: 6px 8px;
            background: #0f1317;
            border: 1px solid #2a2f36;
            border-radius: 4px;
            color: #e0e0e0;
            font-family: var(--font-mono);
            font-size: 11px;
        }

        .file-attach-input::placeholder {
            color: #666;
        }

        .file-attach-button {
            padding: 6px 10px;
            background: var(--accent-color);
            border: none;
            border-radius: 4px;
            color: #000;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
        }

        .file-attach-hint {
            margin-top: 6px;
            font-size: 10px;
            color: #666;
        }

        /* File Search */
        #file-search-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 320px;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-left: 3px solid var(--accent-color);
            border-radius: 4px;
            z-index: 15;
            box-shadow: -8px 8px 20px rgba(0, 0, 0, 0.45);
        }

        #file-search-panel .panel-header {
            padding: 8px 12px;
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #0f1216;
        }

        #file-search-panel .panel-title {
            font-size: 10px;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #8fb9ff;
            font-weight: bold;
        }

        #file-search-input {
            width: 100%;
            margin: 10px 0 6px;
            padding: 8px 10px;
            border: 1px solid #222;
            border-radius: 4px;
            background: #0b0d10;
            color: var(--text-color);
            font-family: var(--font-mono);
            font-size: 11px;
        }

        #file-search-results {
            max-height: 260px;
            overflow-y: auto;
            font-family: var(--font-mono);
            font-size: 11px;
        }

        .file-search-row {
            padding: 8px 10px;
            border-top: 1px solid #1a1d22;
            cursor: pointer;
        }

        .file-search-row:hover {
            background: rgba(0, 255, 204, 0.08);
        }

        .file-search-path {
            color: #e0e0e0;
            margin-bottom: 4px;
            word-break: break-all;
        }

        .file-search-goal {
            color: #8fb9ff;
            font-size: 10px;
        }

        .file-search-meta {
            color: #666;
            font-size: 9px;
            margin-top: 4px;
        }

        .node.search-hit {
            border-color: #8fb9ff;
            box-shadow: 0 0 12px rgba(143, 185, 255, 0.35);
        }

        .ft-item {
            font-family: var(--font-mono);
            font-size: 11px;
            padding: 2px 0;
        }

        .ft-folder {
            color: #eebb00;
        }

        .ft-file {
            color: #aaa;
        }

        .btn-gen {
            background: var(--accent-color);
            color: #000;
            font-weight: bold;
            border: none;
            padding: 8px;
            width: 100%;
            margin-top: 10px;
            cursor: pointer;
            border-radius: 4px;
            text-transform: uppercase;
            font-size: 11px;
        }

        .btn-gen:hover {
            background: #fff;
        }
    </style>
</head>

<body>

    <div id="app-container">
        <div id="view-graph">
            <div id="graph-content">
                <svg class="connections" id="graph-svg"></svg>
                <div id="graph-nodes"></div>
            </div>
            <div class="graph-legend">
                <div style="margin-bottom:5px; font-weight:bold; color:white">DATA FLOW TYPES</div>
                <div class="legend-item">
                    <div class="legend-color" style="background:var(--color-schema)"></div>Schemas
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background:var(--color-auth)"></div>Auth/Security
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background:var(--color-api)"></div>API/Events
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background:var(--color-data)"></div>Data Exports
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background:var(--color-log)"></div>Logs
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Panel -->
    <div id="detail-panel">
        <div class="panel-header">
            <div class="panel-title" id="panel-title">DETAILS</div>
            <div class="panel-close" onclick="UI.closePanel()">√ó</div>
        </div>
        <div class="panel-content" id="panel-body"></div>
    </div>

    <!-- Full Screen Dashboard Overlay -->
    <div id="full-dashboard-overlay"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; overflow-y:auto; background:rgba(0,0,0,0.92); z-index:2000; flex-direction:column; padding:20px; box-sizing:border-box;">

        <!-- Dashboard Header -->
        <div
            style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:15px; margin-bottom:20px; flex-shrink:0;">
            <div style="display:flex; align-items:center; gap:20px;">
                <div>
                    <div
                        style="font-size:10px; color:#888; text-transform:uppercase; letter-spacing:1px; margin-bottom:5px;">
                        COMPONENT DASHBOARD</div>
                    <h1 id="db-title" style="margin:0; color:#00ffcc; text-transform:uppercase; font-size:24px;"></h1>
                </div>
                <!-- Completion Score Circle -->
                <div id="db-score-container" style="position:relative; width:70px; height:70px;">
                    <svg width="70" height="70" style="transform:rotate(-90deg);">
                        <circle cx="35" cy="35" r="30" stroke="#222" stroke-width="6" fill="none" />
                        <circle id="db-score-ring" cx="35" cy="35" r="30" stroke="#00ffcc" stroke-width="6" fill="none"
                            stroke-dasharray="188.5" stroke-dashoffset="188.5" stroke-linecap="round" />
                    </svg>
                    <div id="db-score-text"
                        style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:16px; font-weight:bold; color:#fff;">
                        0%</div>
                </div>
            </div>
            <div style="display:flex; gap:20px; align-items:center;">
                <div style="text-align:right;">
                    <div style="font-size:10px; color:#666;">LAST EDITED</div>
                    <div id="db-last-edited" style="color:#fff; font-family:'Consolas',monospace;"></div>
                </div>
                <div onclick="document.getElementById('full-dashboard-overlay').style.display='none'"
                    style="cursor:pointer; color:#888; font-size:32px; margin-left:20px;">√ó</div>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div
            style="display:grid; grid-template-columns: 1fr 1fr 1fr; grid-template-rows: auto; gap:12px; padding-bottom:20px;">

            <!-- Row 1: Goal (spans 2), Problem -->
            <div
                style="background:linear-gradient(135deg, #1a1f25, #0b0d10); border:1px solid #00ffcc33; padding:15px; border-radius:4px; grid-column: 1 / 3;">
                <h3 style="margin:0 0 10px 0; color:#00ffcc; font-size:13px; text-transform:uppercase;">üéØ Goal</h3>
                <div id="db-goal" style="color:#fff; font-size:15px; line-height:1.5;"></div>
            </div>
            <div style="background:#0b0d10; border:1px solid #ff6b6b33; padding:15px; border-radius:4px;">
                <h3 style="margin:0 0 10px 0; color:#ff6b6b; font-size:13px; text-transform:uppercase;">‚ö†Ô∏è Problem</h3>
                <div id="db-problem" style="color:#ccc; font-size:13px; line-height:1.5; font-style:italic;"></div>
            </div>

            <!-- Row 2: Scope, Requirements, Risks -->
            <div style="background:#0b0d10; border:1px solid #333; padding:15px; border-radius:4px;">
                <h3 style="margin:0 0 10px 0; color:#3498db; font-size:12px; text-transform:uppercase;">üì¶ Scope</h3>
                <ul id="db-scope" style="margin:0; padding-left:18px; font-size:12px; color:#bbb; line-height:1.6;">
                </ul>
            </div>
            <div style="background:#0b0d10; border:1px solid #333; padding:15px; border-radius:4px;">
                <h3 style="margin:0 0 10px 0; color:#9b59b6; font-size:12px; text-transform:uppercase;">üìã Requirements
                </h3>
                <ul id="db-requirements"
                    style="margin:0; padding-left:18px; font-size:12px; color:#bbb; line-height:1.6;"></ul>
            </div>
            <div style="background:#0b0d10; border:1px solid #e74c3c33; padding:15px; border-radius:4px;">
                <h3 style="margin:0 0 10px 0; color:#e74c3c; font-size:12px; text-transform:uppercase;">‚ö° Risks</h3>
                <ul id="db-risks" style="margin:0; padding-left:18px; font-size:12px; color:#aaa; line-height:1.6;">
                </ul>
            </div>

            <!-- Row 3: Tasks, Summary+Metrics, Files -->
            <div
                style="background:#0b0d10; border:1px solid #333; padding:15px; border-radius:4px; display:flex; flex-direction:column; overflow-y:auto;">
                <h3 style="margin:0 0 10px 0; color:#ffaa00; font-size:12px; text-transform:uppercase;">üìã Tasks</h3>
                <div id="db-subtasks" style="font-size:13px; color:#ccc; flex:1;"></div>
                <div
                    style="padding-top:10px; border-top:1px solid #222; font-size:11px; color:#888; font-family:'Consolas',monospace;">
                    STATUS: <span id="db-status" style="color:#fff"></span><br>
                    OWNER: <span id="db-owner" style="color:#fff"></span>
                </div>
            </div>
            <div
                style="background:#0b0d10; border:1px solid #333; padding:15px; border-radius:4px; display:flex; flex-direction:column;">
                <h3 style="margin:0 0 10px 0; color:#888; font-size:12px; text-transform:uppercase;">Summary</h3>
                <div id="db-desc"
                    style="color:#e0e0e0; font-size:13px; line-height:1.5; margin-bottom:12px; padding-bottom:10px; border-bottom:1px solid #222;">
                </div>

                <!-- Agent Control Panel (User Interaction) -->
                <div id="db-agent-panel" style="display:none; margin-bottom:15px;"></div>

                <h3 style="margin:0 0 8px 0; color:#f39c12; font-size:11px; text-transform:uppercase;">üìä Metrics (vs
                    Requirements)</h3>
                <div id="db-metrics" style="font-size:11px; color:#ccc; flex:1; overflow-y:auto;"></div>
            </div>
            <div
                style="background:#0b0d10; border:1px solid #333; padding:15px; border-radius:4px; display:flex; flex-direction:column;">
                <h3 style="margin:0 0 10px 0; color:#888; font-size:12px; text-transform:uppercase;">Files</h3>
                <div id="db-files"
                    style="flex:1; overflow-y:auto; font-family:'Consolas',monospace; font-size:12px; color:#aaa;">
                </div>
            </div>

            <!-- Row 4: Inputs, Outputs, Timeline -->
            <div style="grid-column: 1 / 4; display:flex; gap:12px; min-height:120px;">
                <div style="flex:1; background:#0b0d10; border:1px solid #333; padding:15px; border-radius:4px;">
                    <h3 style="margin:0 0 10px 0; color:#3498db; font-size:12px; text-transform:uppercase;">üì• Inputs
                    </h3>
                    <div id="db-inputs" style="font-size:13px; color:#ccc; display:flex; flex-wrap:wrap; gap:8px;">
                    </div>
                </div>
                <div style="flex:1; background:#0b0d10; border:1px solid #333; padding:15px; border-radius:4px;">
                    <h3 style="margin:0 0 10px 0; color:#2ecc71; font-size:12px; text-transform:uppercase;">üì§ Outputs
                    </h3>
                    <div id="db-outputs" style="font-size:13px; color:#ccc; display:flex; flex-wrap:wrap; gap:8px;">
                    </div>
                </div>
                <div style="flex:1; background:#0b0d10; border:1px solid #1abc9c33; padding:15px; border-radius:4px;">
                    <h3 style="margin:0 0 10px 0; color:#1abc9c; font-size:12px; text-transform:uppercase;">üß™ Test
                        Cases</h3>
                    <div id="db-timeline" style="font-size:11px; color:#ccc; overflow-y:auto; max-height:100px;"></div>
                </div>
            </div>

        </div>
    </div>


    <!-- Global Task List Button & Panel -->
    <div id="task-list-panel"
        style="position:absolute; bottom:20px; right:20px; width:300px; background:var(--panel-bg); border:1px solid var(--border-color); border-radius:4px; display:none; z-index:100; box-shadow:-5px -5px 20px rgba(0,0,0,0.5);">
        <div class="panel-header">
            <div class="panel-title">GLOBAL TASKS</div>
            <div class="panel-close" onclick="document.getElementById('task-list-panel').style.display='none'">√ó</div>
        </div>
        <div class="panel-content">
            <ul id="global-task-ul" style="padding-left:20px; margin:0; list-style:none;">
                <!-- Populated via JS -->
            </ul>
        </div>
    </div>
    <button onclick="document.getElementById('task-list-panel').style.display='block'"
        style="position:absolute; bottom:20px; right:20px; z-index:90; padding:10px 15px; background:var(--accent-color); border:none; border-radius:4px; font-weight:bold; cursor:pointer; box-shadow:0 0 10px rgba(0,255,204,0.3);">
        üìã TASKS
    </button>

    <div id="file-search-panel">
        <div class="panel-header">
            <div class="panel-title">FILE TO GOAL</div>
            <div style="font-size:9px; color:#666;">SEARCH</div>
        </div>
        <div style="padding: 10px 12px 12px;">
            <input id="file-search-input" type="search" placeholder="Search file path (e.g. scrape_v3.js)"
                autocomplete="off" />
            <div id="file-search-results">
                <div style="padding:8px 0; color:#666; font-size:10px;">Type a file name to see linked goals.</div>
            </div>
        </div>
    </div>

    <script>
        // --- Data ---
        // Global Tasks Data (Project-level view)
        const GlobalTasks = [
            { text: "Phase 1: Interview - Gather requirements", done: true },
            { text: "Phase 2: Design - Create component tree", done: true },
            { text: "Phase 3: Visualize - User reviews design", done: true },
            { text: "Phase 4: Plan - General Manager creates work plan", done: false },
            { text: "Phase 5: Breakdown - Managers create tasks", done: false },
            { text: "Phase 6: Assign - Managers assign agents", done: false },
            { text: "Phase 7: Execute - Agents complete tasks", done: false }
        ];

        // Level 1: Agent Hierarchy View
        const Level1 = {
            nodes: [
                {
                    // [LEVEL 0] The Abstract Project Root
                    id: 'PROJECT', label: 'Lead Enrichment Project', x: 500, y: 50, type: 'root', agentId: null, status: 'active',
                    lastEdited: "2026-01-13 15:25", summary: "Build a multi-stage web scraper to enrich leads with pricing.",
                    problem: "CSV files with names but no pricing. Manually checking sites is too slow.",
                    goals: ["Automate pricing extraction", "Extract contacts", "Track availability"],
                    scope: ["Interview to Execute workflow", "SQLite state", "Agent compartmentalization"],
                    requirements: ["Process 500+ leads", ">70% capture", "Resume on crash"],
                    metrics: [
                        { req: "Process 500+ leads", value: "487/500", status: "pass" },
                        { req: ">70% capture", value: "73%", status: "pass" },
                        { req: "Resume on crash", value: "Implemented", status: "pass" }
                    ],
                    risks: ["Site changes", "Rate limiting"],
                    testCases: [
                        { name: "V1 finds websites", status: "pass", value: "92%" },
                        { name: "V2 extracts pricing", status: "pass", value: "73%" },
                        { name: "V3 hidden pricing", status: "pending" },
                        { name: "V4 pagination", status: "pending" },
                        { name: "Resume after crash", status: "pass" }
                    ],
                    inputs: ["User transcript"], outputs: ["Enriched CSVs"], files: [], subtasks: []
                },
                {
                    // [LEVEL 1] INTERVIEWER
                    id: 'INTERVIEWER', label: 'Interviewer', x: 500, y: 200, type: 'node', agentId: 'INT', status: 'complete',
                    lastEdited: "2026-01-13 10:00", summary: "Conducted project interview. Gathered requirements.",
                    problem: "Need to understand what user wants.", goals: ["Clarify scope", "Identify edge cases"],
                    scope: ["User conversation only"], requirements: ["project_brief.md"], metrics: ["Requirements captured"],
                    risks: ["Incomplete requirements"], timeline: [{ phase: "Complete", done: true }],
                    inputs: ["User conversation"], outputs: ["responses.json"],
                    subtasks: [{ title: "Ask about sources", logic: "Where do leads come from?" }], files: []
                },
                {
                    // [LEVEL 2] ARCHITECT
                    id: 'ARCHITECT', label: 'Architect', x: 500, y: 350, type: 'node', agentId: 'ARCH', status: 'complete',
                    lastEdited: "2026-01-13 11:30", summary: "Analyzing Interviewer responses. Designing system components.",
                    problem: "Translate user responses into a folder structure.", goals: ["Define tree", "Map dependencies"],
                    scope: ["responses.json only"], requirements: ["Components in DB"], metrics: ["All components mapped"],
                    risks: ["Missing dependencies"], timeline: [{ phase: "Complete", done: true }],
                    inputs: ["responses.json"], outputs: ["components.json"],
                    subtasks: [{ title: "Create components", logic: "V1-V5 stages" }], files: []
                },
                {
                    // [LEVEL 3] GENERAL MANAGER
                    id: 'GM', label: 'General Manager', x: 500, y: 500, type: 'node', agentId: 'GM', status: 'active',
                    lastEdited: "2026-01-13 15:00", summary: "Reviewing components & end goal. Breaking down into Small Projects.",
                    problem: "Orchestrate managers and create plan.", goals: ["Create plan", "Spawn managers"],
                    scope: ["components.json", "End Goal"], requirements: ["Work plan", "Assignments"], metrics: ["All have managers"],
                    risks: ["Resource contention"], timeline: [{ phase: "Review", done: true }, { phase: "Create Plan", done: false }],
                    inputs: ["components.json"], outputs: ["small_projects_plan.json"],
                    subtasks: [{ title: "Review tree", logic: "Understand scope" }], files: []
                },
                // WORKER TIER
                {
                    id: 'MGR_INPUT', label: 'Manager: Input', x: 150, y: 650, type: 'node', agentId: 'MGR1', status: 'pending',
                    lastEdited: "2026-01-13 15:10", summary: "Managing Input Project. Assigning validation tasks.",
                    problem: "Ensure input quality.", goals: ["Validate", "Deduplicate"],
                    scope: ["CSV_Dumps only"], requirements: ["Clean input"], metrics: ["0 duplicates"],
                    risks: ["Bad format"], timeline: [{ phase: "Task Creation", done: false }],
                    inputs: ["Raw CSVs"], outputs: ["Validated leads"], subtasks: [], files: []
                },
                {
                    id: 'MGR_SCRAPE', label: 'Manager: Scrapers', x: 500, y: 650, type: 'node', agentId: 'MGR2', status: 'pending',
                    lastEdited: "2026-01-13 15:10", summary: "Managing Scraper Project. Assigning coding tasks.",
                    problem: "Coordinate multi-stage scraping.", goals: ["Implement scrapers", "Handle errors"],
                    scope: ["Scraper components"], requirements: [">70% capture"], metrics: ["Capture %", "Error rate"],
                    risks: ["Site blocks", "Crashes"], timeline: [{ phase: "Tasks", done: false }, { phase: "Assign", done: false }],
                    inputs: ["Validated leads"], outputs: ["Enriched data"], subtasks: [], files: []
                },
                {
                    id: 'MGR_OUTPUT', label: 'Manager: Output', x: 850, y: 650, type: 'node', agentId: 'MGR3', status: 'pending',
                    lastEdited: "2026-01-13 15:10", summary: "Manages output. Final merge and validation.",
                    problem: "Ensure complete output.", goals: ["Merge stages", "Validate"],
                    scope: ["enriched_csvs"], requirements: ["Complete dataset"], metrics: ["100% merged"],
                    risks: ["Merge conflicts"], timeline: [{ phase: "Task Creation", done: false }],
                    inputs: ["V5 output"], outputs: ["final_enriched.csv"], subtasks: [], files: []
                },
                {
                    id: 'AGENT_V1', label: 'Agent: V1', x: 250, y: 800, type: 'node', agentId: 'A1', status: 'pending',
                    lastEdited: "2026-01-13 15:15", summary: "Implement V1 scraper. Find websites/phones.",
                    problem: "Find websites from names.", goals: ["Find URLs", "Extract phones"],
                    scope: ["Task: V1 only"], requirements: ["500 leads"], metrics: [">90% found"],
                    risks: ["Rate limits"], timeline: [{ phase: "Implementation", done: false }],
                    inputs: ["Leads CSV"], outputs: ["leads_enriched.csv"],
                    subtasks: [{ title: "Implement V1", logic: "scrape_leads.js" }], files: [{ name: 'scrape_leads.js', type: 'file' }]
                },
                {
                    id: 'AGENT_V2', label: 'Agent: V2', x: 500, y: 800, type: 'node', agentId: 'A2', status: 'pending',
                    lastEdited: "2026-01-13 15:15", summary: "Implement V2 scraper. Extract pricing.",
                    problem: "Extract pricing from websites.", goals: ["Extract pricing", "Handle dynamic"],
                    scope: ["Task: V2 only"], requirements: [">70% pricing"], metrics: ["Capture rate"],
                    risks: ["Dynamic JS"], timeline: [{ phase: "Implementation", done: false }],
                    inputs: ["leads_enriched.csv"], outputs: ["leads_enriched_v2.csv"],
                    subtasks: [{ title: "Implement V2", logic: "scrape_deep.js" }], files: [{ name: 'scrape_deep.js', type: 'file' }]
                },
                {
                    id: 'AGENT_V3', label: 'Agent: V3', x: 750, y: 800, type: 'node', agentId: 'A3', status: 'pending',
                    lastEdited: "2026-01-13 15:15", summary: "Implement V3. Hidden pricing via buttons.",
                    problem: "Sites hide pricing behind buttons.", goals: ["Click buttons", "Extract hidden"],
                    scope: ["Task: V3 only"], requirements: ["+10% pricing"], metrics: ["Incremental"],
                    risks: ["Complex interactions"], timeline: [{ phase: "Implementation", done: false }],
                    inputs: ["leads_enriched_v2.csv"], outputs: ["leads_enriched_v3.csv"],
                    subtasks: [{ title: "Implement V3", logic: "scrape_v3.js" }], files: [{ name: 'scrape_v3.js', type: 'file' }]
                }
            ],
            edges: [
                { from: 'PROJECT', to: 'INTERVIEWER', label: 'Phase 1', type: 'data' },
                { from: 'INTERVIEWER', to: 'ARCHITECT', label: 'Transcript', type: 'data' },
                { from: 'ARCHITECT', to: 'GM', label: 'Design', type: 'data' },
                { from: 'GM', to: 'MGR_INPUT', label: 'Assigns', type: 'api' },
                { from: 'GM', to: 'MGR_SCRAPE', label: 'Assigns', type: 'api' },
                { from: 'GM', to: 'MGR_OUTPUT', label: 'Assigns', type: 'api' },
                { from: 'MGR_SCRAPE', to: 'AGENT_V1', label: 'Creates', type: 'api' },
                { from: 'MGR_SCRAPE', to: 'AGENT_V2', label: 'Creates', type: 'api' },
                { from: 'MGR_SCRAPE', to: 'AGENT_V3', label: 'Creates', type: 'api' },
                { from: 'MGR_INPUT', to: 'AGENT_V1', label: 'Input', type: 'data' },
                { from: 'AGENT_V1', to: 'AGENT_V2', label: 'V1-V2', type: 'data' },
                { from: 'AGENT_V2', to: 'AGENT_V3', label: 'V2-V3', type: 'data' },
                { from: 'AGENT_V3', to: 'MGR_OUTPUT', label: 'Final', type: 'data' }
            ]
        };

        // Level 2: Task-Level View (zoomed into Scraper Manager)
        const Level2 = {
            nodes: [
                {
                    id: 'MGR', label: 'Manager: Scrapers', x: 500, y: 50, type: 'root', agentId: 'MGR2', status: 'active',
                    summary: "Managing scraper component. Creating and assigning tasks to agents.",
                    problem: "Need granular control over scraping logic.",
                    goals: ["Break down into tasks", "Assign agents", "Monitor progress"],
                    scope: ["Scraper Component Scope"], requirements: ["High throughput", "Low error rate"],
                    metrics: ["Tasks completed"], risks: ["Agent hallucinations"], timeline: [],
                    inputs: ["Component requirements"], outputs: ["Tasks assigned"],
                    subtasks: [], files: [], lastEdited: "Today"
                },
                // Tasks
                {
                    id: 'T1', label: 'Task: Implement V1', x: 100, y: 300, type: 'node', agentId: 'A1', status: 'in_progress',
                    summary: "Build primary Google Maps scraper to find websites and phones.",
                    problem: "Missing basic contact info.",
                    goals: ["Find websites", "Extract phones"], requirements: ["500+ leads"],
                    scope: ["V1 Task Scope"], metrics: ["95% success"], risks: ["IP bans"], timeline: [],
                    inputs: ["Raw leads"], outputs: ["leads_enriched.csv"],
                    subtasks: [{ title: "Code scrape_leads.js", logic: "Google Maps lookup" }],
                    files: [{ name: 'scrape_leads.js', type: 'file' }], lastEdited: "Today"
                },
                {
                    id: 'T2', label: 'Task: Implement V2', x: 500, y: 300, type: 'node', agentId: 'A2', status: 'pending',
                    summary: "Build deep scraper to extract pricing from websites.",
                    problem: "Pricing is often hidden or complex.",
                    goals: ["Extract pricing"], requirements: [">70% capture"],
                    scope: ["V2 Task Scope"], metrics: ["Price accuracy"], risks: ["Dynamic content"], timeline: [],
                    inputs: ["leads_enriched.csv"], outputs: ["leads_enriched_v2.csv"],
                    subtasks: [{ title: "Code scrape_deep.js", logic: "Website scraping" }],
                    files: [{ name: 'scrape_deep.js', type: 'file' }], lastEdited: "Today"
                },
                {
                    id: 'T3', label: 'Task: Implement V3', x: 900, y: 300, type: 'node', agentId: 'A3', status: 'pending',
                    summary: "Build specifics scraper for hidden pricing.",
                    problem: "Some sites require interaction.",
                    goals: ["Find hidden prices"], requirements: ["+10% incremental"],
                    scope: ["V3 Task Scope"], metrics: ["Interaction success"], risks: ["Complex DOM"], timeline: [],
                    inputs: ["leads_enriched_v2.csv"], outputs: ["leads_enriched_v3.csv"],
                    subtasks: [{ title: "Code scrape_v3.js", logic: "Button interactions" }],
                    files: [{ name: 'scrape_v3.js', type: 'file' }], lastEdited: "Today"
                },
                {
                    id: 'T4', label: 'Task: Implement V4', x: 300, y: 550, type: 'node', agentId: null, status: 'pending',
                    summary: "Build Load More handler for paginated sites.",
                    problem: "Pagination hides results.",
                    goals: ["Handle pagination"], requirements: ["Load More logic"],
                    scope: ["V4 Task Scope"], metrics: ["Pages loaded"], risks: ["Infinite loops"], timeline: [],
                    inputs: ["leads_enriched_v3.csv"], outputs: ["leads_enriched_v4.csv"],
                    subtasks: [{ title: "Code scrape_v4.js", logic: "Pagination handling" }],
                    files: [{ name: 'scrape_v4.js', type: 'file' }], lastEdited: "Today"
                },
                {
                    id: 'T5', label: 'Task: Implement V5', x: 700, y: 550, type: 'node', agentId: null, status: 'pending',
                    summary: "Build unblocker for sites with client-side blocks.",
                    problem: "Anti-bot measures.",
                    goals: ["Bypass blocks"], requirements: ["Stealth mode"],
                    scope: ["V5 Task Scope"], metrics: ["Bypass rate"], risks: ["Detection"], timeline: [],
                    inputs: ["leads_enriched_v4.csv"], outputs: ["final.csv"],
                    subtasks: [{ title: "Code scrape_v5.js", logic: "Anti-block measures" }],
                    files: [{ name: 'scrape_v5.js', type: 'file' }], lastEdited: "Today"
                },
                // Agents
                {
                    id: 'A1', label: 'Agent 1', x: 100, y: 550, type: 'node', agentId: 'A1', status: 'working',
                    summary: "Working on V1 implementation.",
                    problem: "N/A", goals: ["Complete T1"], requirements: [], scope: ["Agent Scope"], metrics: [], risks: [], timeline: [],
                    inputs: ["Task T1"], outputs: ["Code + status"],
                    subtasks: [], files: [], lastEdited: "Today"
                },
                {
                    id: 'A2', label: 'Agent 2', x: 500, y: 550, type: 'node', agentId: 'A2', status: 'idle',
                    summary: "Waiting for V1 completion.",
                    problem: "N/A", goals: ["Complete T2"], requirements: [], scope: ["Agent Scope"], metrics: [], risks: [], timeline: [],
                    inputs: ["Task T2"], outputs: ["Code + status"],
                    subtasks: [], files: [], lastEdited: "Today"
                }
            ],
            edges: [
                { from: 'MGR', to: 'T1', label: 'Created', type: 'api' },
                { from: 'MGR', to: 'T2', label: 'Created', type: 'api' },
                { from: 'MGR', to: 'T3', label: 'Created', type: 'api' },
                { from: 'MGR', to: 'T4', label: 'Created', type: 'api' },
                { from: 'MGR', to: 'T5', label: 'Created', type: 'api' },
                { from: 'T1', to: 'A1', label: 'Assigned', type: 'auth' },
                { from: 'T2', to: 'A2', label: 'Assigned', type: 'auth' },
                { from: 'T1', to: 'T2', label: 'Depends', type: 'data' },
                { from: 'T2', to: 'T3', label: 'Depends', type: 'data' },
                { from: 'T3', to: 'T4', label: 'Depends', type: 'data' },
                { from: 'T4', to: 'T5', label: 'Depends', type: 'data' }
            ]
        };

        const Agents = [
            { id: 'INT', name: 'Interviewer', dept: 'DISC', initials: 'üé§', status: 'complete' },
            { id: 'ARCH', name: 'Architect', dept: 'DES', initials: 'üìê', status: 'complete' },
            { id: 'GM', name: 'General Manager', dept: 'MGT', initials: 'üëî', status: 'active' },
            { id: 'MGR1', name: 'Input Manager', dept: 'MGT', initials: 'M1', status: 'pending' },
            { id: 'MGR2', name: 'Scraper Manager', dept: 'MGT', initials: 'M2', status: 'pending' },
            { id: 'MGR3', name: 'Output Manager', dept: 'MGT', initials: 'M3', status: 'pending' },
            { id: 'A1', name: 'Agent 1 (V1)', dept: 'DEV', initials: 'A1', status: 'pending' },
            { id: 'A2', name: 'Agent 2 (V2)', dept: 'DEV', initials: 'A2', status: 'pending' },
            { id: 'A3', name: 'Agent 3 (V3)', dept: 'DEV', initials: 'A3', status: 'pending' }
        ];

        const State = {
            agents: Agents,
            graphNodes: Level1.nodes,
            graphEdges: Level1.edges,
            graphPan: { x: 0, y: 0 },
            currentLevel: 1,
            fileSearch: { query: '', matches: [], selectedNodeId: null }
        };

        const escapeSingleQuotes = (value) => (value || '').replace(/'/g, "\\'");

        // --- Logic ---
        let dragNodeId = null;
        let dragOffset = { x: 0, y: 0 };
        let isGraphPanning = false;
        let panStart = { x: 0, y: 0 };

        const UI = {
            makeDraggable: (elId, handleSelector) => {
                const el = document.getElementById(elId);
                const handle = el ? el.querySelector(handleSelector) : null;
                if (!el || !handle) return;

                handle.style.cursor = 'grab';
                let isDragging = false;
                let startX, startY, initialLeft, initialTop;

                handle.onmousedown = (e) => {
                    e.preventDefault();
                    isDragging = true;
                    handle.style.cursor = 'grabbing';

                    const rect = el.getBoundingClientRect();
                    el.style.left = rect.left + 'px';
                    el.style.top = rect.top + 'px';
                    el.style.bottom = 'auto';
                    el.style.right = 'auto';

                    startX = e.clientX;
                    startY = e.clientY;
                    initialLeft = rect.left;
                    initialTop = rect.top;

                    const onMove = (e) => {
                        if (!isDragging) return;
                        const dx = e.clientX - startX;
                        const dy = e.clientY - startY;
                        el.style.left = (initialLeft + dx) + 'px';
                        el.style.top = (initialTop + dy) + 'px';
                    };

                    const onUp = () => {
                        isDragging = false;
                        handle.style.cursor = 'grab';
                        document.removeEventListener('mousemove', onMove);
                        document.removeEventListener('mouseup', onUp);
                    };

                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('mouseup', onUp);
                };
            },

            init: () => {
                const container = document.getElementById('app-container');
                const btn = document.createElement('button');
                btn.innerText = "Switch View (Level 1/2)";
                btn.style.position = "absolute";
                btn.style.top = "20px";
                btn.style.left = "20px";
                btn.style.zIndex = "100";
                btn.style.padding = "10px 20px";
                btn.style.background = "var(--accent-color)";
                btn.style.border = "none";
                btn.style.fontWeight = "bold";
                btn.style.cursor = "pointer";
                btn.style.borderRadius = "4px";
                btn.onclick = UI.toggleView;
                container.appendChild(btn);

                UI.renderGraph();
                UI.renderGlobalTasks();
                UI.initFileSearch();

                // Initialize Draggable Panels
                UI.makeDraggable('detail-panel', '.panel-header');
                UI.makeDraggable('task-list-panel', '.panel-header');
            },

            renderGlobalTasks: () => {
                const list = document.getElementById('global-task-ul');
                list.innerHTML = GlobalTasks.map(t => `
        <li
            style="margin-bottom:8px; display:flex; align-items:center; color:${t.done ? '#666' : '#fff'}; text-decoration:${t.done ? 'line-through' : 'none'}">
            <span style="color:${t.done ? '#00ffcc' : '#ffaa00'}; margin-right:8px; font-weight:bold;">${t.done ? '‚úì' :
                        '‚óã'}</span>
            ${t.text}
        </li>
        `).join('');
            },

            // Calculate weighted completion score
            calculateScore: (node) => {
                // Default weights: Metrics = 60%, Test Cases = 40%
                const METRICS_WEIGHT = 0.6;
                const TESTS_WEIGHT = 0.4;

                let metricsScore = 0;
                let testsScore = 0;
                let hasMetrics = false;
                let hasTests = false;

                // Calculate metrics score (based on pass/fail status and individual weights)
                if (node.metrics && node.metrics.length > 0 && typeof node.metrics[0] === 'object') {
                    hasMetrics = true;
                    let totalWeight = 0;
                    let earnedWeight = 0;

                    node.metrics.forEach(m => {
                        const weight = m.weight || 1; // Default weight of 1 if not specified
                        totalWeight += weight;
                        if (m.status === 'pass') {
                            earnedWeight += weight;
                        } else if (m.status === 'partial') {
                            earnedWeight += weight * 0.5;
                        }
                    });

                    metricsScore = totalWeight > 0 ? (earnedWeight / totalWeight) * 100 : 0;
                }

                // Calculate test cases score
                if (node.testCases && node.testCases.length > 0) {
                    hasTests = true;
                    let totalWeight = 0;
                    let earnedWeight = 0;

                    node.testCases.forEach(tc => {
                        const weight = tc.weight || 1; // Default weight of 1
                        totalWeight += weight;
                        if (tc.status === 'pass') {
                            earnedWeight += weight;
                        } else if (tc.status === 'partial') {
                            earnedWeight += weight * 0.5;
                        }
                    });

                    testsScore = totalWeight > 0 ? (earnedWeight / totalWeight) * 100 : 0;
                }

                // Calculate weighted final score
                let finalScore = 0;
                if (hasMetrics && hasTests) {
                    finalScore = (metricsScore * METRICS_WEIGHT) + (testsScore * TESTS_WEIGHT);
                } else if (hasMetrics) {
                    finalScore = metricsScore;
                } else if (hasTests) {
                    finalScore = testsScore;
                } else {
                    // Fallback: check node status
                    if (node.status === 'complete') finalScore = 100;
                    else if (node.status === 'active') finalScore = 50;
                    else if (node.status === 'pending') finalScore = 0;
                }

                return {
                    total: Math.round(finalScore),
                    metricsScore: Math.round(metricsScore),
                    testsScore: Math.round(testsScore),
                    hasMetrics,
                    hasTests
                };
            },

            // Render the "Live" Agent Control Panel
            renderAgentControl: (node, agentName) => {
                const isAgent = node.type === 'node' || node.input === 'AGENT'; // Simple check
                // Randomized dummy data for demo
                const sessionID = 'sess_' + Math.random().toString(36).substr(2, 6);
                const iteration = Math.floor(Math.random() * 20) + 1;
                const cost = (Math.random() * 5).toFixed(2);
                const progress = Math.floor(Math.random() * 100);

                // Criteria map from node metrics/tasks
                let criteriaHtml = '';
                if (node.metrics && node.metrics.length) {
                    criteriaHtml = node.metrics.slice(0, 4).map(m => {
                        const text = typeof m === 'object' ? m.req : m;
                        const status = typeof m === 'object' ? m.status : (Math.random() > 0.5 ? 'pass' : 'pending');
                        const icon = status === 'pass' ? '‚úì' : '‚óã';
                        return `<div style="font-family:'Consolas',monospace; font-size:11px; color:${status === 'pass' ? '#2ecc71' : '#888'}">${icon} ${text}</div>`;
                    }).join('');
                } else {
                    criteriaHtml = '<div style="color:#666; font-size:10px;">Waiting for criteria...</div>';
                }

                // Logs
                const logs = [
                    "Checking availability...",
                    "Connecting to proxy...",
                    "Parsing response...",
                    "WARN: Retrying request...",
                    "Success: Data extracted"
                ];
                const activeLogs = logs.sort(() => 0.5 - Math.random()).slice(0, 3).map(l =>
                    `<div style="font-family:'Consolas',monospace; font-size:10px; color:#aaa;">${new Date().toLocaleTimeString().split(' ')[0]} > ${l}</div>`
                ).join('');

                const progressBar = `
                    <div style="height:10px; background:#222; margin:5px 0;">
                        <div style="width:${progress}%; height:100%; background:repeating-linear-gradient(45deg, #3498db, #3498db 10px, #2980b9 10px, #2980b9 20px);"></div>
                    </div>
                `;

                return `
                    <div style="background:#000; border:1px solid #444; color:#fff; font-family:'Consolas', 'Courier New', monospace; box-shadow:0 0 15px rgba(0,0,0,0.5);">
                        <!-- Header -->
                        <div style="background:#222; padding:5px 10px; border-bottom:1px solid #444; display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight:bold; color:#fff;">TERMINAL: ${node.label.toUpperCase()}</span>
                            <span style="color:#888;">[‚óè]</span>
                        </div>
                        
                        <!-- Info -->
                        <div style="padding:10px; border-bottom:1px solid #333;">
                            <div style="display:flex; justify-content:space-between;">
                                <span style="color:#888;">Status: <span style="color:#2ecc71;">ACTIVE</span></span>
                                <span style="color:#888;">Agent: <span style="color:#fff;">${agentName}</span></span>
                            </div>
                            <div style="color:#666; font-size:11px;">Session: ${sessionID}</div>
                        </div>

                        <!-- Progress & Cost -->
                        <div style="padding:10px; border-bottom:1px solid #333; background:#0b0d10;">
                            <div style="display:flex; justify-content:space-between; font-size:11px; color:#ccc;">
                                <span>Progress: ${progress}%</span>
                                <span>Iter: ${iteration}/20</span>
                            </div>
                            ${progressBar}
                            <div style="font-size:11px; color:#888;">Cost: <span style="color:#f39c12;">$${cost}</span> of $10.00</div>
                        </div>

                        <!-- Criteria -->
                        <div style="padding:10px; border-bottom:1px solid #333;">
                            <div style="color:#666; font-size:10px; margin-bottom:4px; text-transform:uppercase;">Criteria Check:</div>
                            ${criteriaHtml}
                        </div>

                        <!-- Logs -->
                        <div style="padding:10px; background:#050505; border-bottom:1px solid #333; min-height:50px;">
                            ${activeLogs}
                        </div>

                        <!-- Controls -->
                        <div style="padding:8px; background:#222; display:flex; gap:8px;">
                            <button style="background:#e74c3c; border:none; color:#fff; padding:4px 8px; font-size:10px; cursor:pointer;">[ PAUSE ]</button>
                            <button style="background:#f39c12; border:none; color:#fff; padding:4px 8px; font-size:10px; cursor:pointer;">[ REASSIGN ]</button>
                            <button style="background:#3498db; border:none; color:#fff; padding:4px 8px; font-size:10px; cursor:pointer;">[ CONTEXT ]</button>
                            <button style="background:#9b59b6; border:none; color:#fff; padding:4px 8px; font-size:10px; cursor:pointer;">[ PR ]</button>
                        </div>
                    </div>
                `;
            },

            toggleView: () => {
                if (State.currentLevel === 1) {
                    State.graphNodes = Level2.nodes;
                    State.graphEdges = Level2.edges;
                    State.currentLevel = 2;
                } else {
                    State.graphNodes = Level1.nodes;
                    State.graphEdges = Level1.edges;
                    State.currentLevel = 1;
                }
                UI.renderGraph();
                if (State.fileSearch.query) {
                    UI.updateFileSearchResults(State.fileSearch.query);
                }
            },

            showDetailedModal: (id) => {
                const node = State.graphNodes.find(n => n.id === id);
                if (!node) return;

                const agent = State.agents.find(a => a.id === node.agentId);
                const agentName = agent ? agent.name : 'Unassigned';

                // Helper for list rendering
                const renderList = (arr, fallback = "None specified.") => {
                    if (!arr || arr.length === 0) return `<li style="color:#666; font-style:italic">${fallback}</li>`;
                    return arr.map(item => `<li>${item}</li>`).join('');
                };

                // Header
                document.getElementById('db-title').innerText = node.label + " (" + node.id + ")";
                document.getElementById('db-last-edited').innerText = node.lastEdited || "Unknown";

                // Calculate and display completion score
                const score = UI.calculateScore(node);
                const circumference = 188.5; // 2 * PI * 30
                const offset = circumference - (score.total / 100) * circumference;

                // Update score ring
                const ring = document.getElementById('db-score-ring');
                ring.style.strokeDashoffset = offset;

                // Color based on score
                let scoreColor = '#e74c3c'; // Red for low
                if (score.total >= 70) scoreColor = '#2ecc71'; // Green
                else if (score.total >= 40) scoreColor = '#f39c12'; // Orange
                ring.style.stroke = scoreColor;

                // Update score text
                document.getElementById('db-score-text').innerText = score.total + '%';
                document.getElementById('db-score-text').style.color = scoreColor;

                // Goal
                document.getElementById('db-goal').innerText = node.goal || node.summary || "No goal defined.";

                // Problem
                document.getElementById('db-problem').innerText = node.problem || "No problem statement defined.";

                // Scope
                document.getElementById('db-scope').innerHTML = renderList(node.scope);

                // Requirements
                document.getElementById('db-requirements').innerHTML = renderList(node.requirements);

                // Risks
                document.getElementById('db-risks').innerHTML = renderList(node.risks, "No risks identified.");

                // Summary (description)
                document.getElementById('db-desc').innerText = node.description || node.summary || "No description available.";

                // Render Agent Control Panel
                const agentPanelContainer = document.getElementById('db-agent-panel');
                if (agentPanelContainer) {
                    agentPanelContainer.innerHTML = UI.renderAgentControl(node, agentName);
                    agentPanelContainer.style.display = 'block';
                }

                // Metrics (show as requirement -> metric pairs with status and weight)
                let metricsHtml = '<div style="color:#666; font-style:italic;">No metrics defined.</div>';
                if (node.metrics && node.metrics.length > 0) {
                    // If metrics is an array of objects with requirement/value/status
                    if (typeof node.metrics[0] === 'object') {
                        // Show score breakdown header
                        // Show score breakdown header
                        metricsHtml = `
                            <div style="display:flex; justify-content:space-between; padding:4px 8px; margin-bottom:8px; background:#1a1f25; border-radius:4px;">
                                <span style="color:#f39c12; font-size:9px;">METRICS SCORE: ${score.metricsScore}%</span>
                                <span style="color:#888; font-size:9px;">Weight: 60%</span>
                            </div>
                            <!-- Column Headers -->
                            <div style="display:flex; justify-content:space-between; padding:0 2px; margin-bottom:2px;">
                                <span style="color:#666; font-size:8px; text-transform:uppercase; letter-spacing:0.5px;">Actual</span>
                                <span style="color:#666; font-size:8px; text-transform:uppercase; letter-spacing:0.5px;">Goal</span>
                            </div>
                        `;

                        metricsHtml += node.metrics.map(m => {
                            const weight = m.weight || 1;
                            const weightBadge = weight > 1 ? `<span style="background:#9b59b622; color:#9b59b6; font-size:8px; padding:1px 4px; border-radius:2px; margin-left:4px;">√ó${weight}</span>` : '';
                            const statusColor = m.status === 'pass' ? '#2ecc71' : m.status === 'fail' ? '#e74c3c' : '#fff';

                            // Parse percentage for bar width
                            let pct = 0;
                            const valStr = (m.value || '').toString();
                            if (valStr.includes('/')) {
                                const parts = valStr.split('/');
                                pct = (parseFloat(parts[0]) / parseFloat(parts[1])) * 100;
                            } else if (valStr.match(/(\d+(\.\d+)?)%/)) {
                                pct = parseFloat(valStr.match(/(\d+(\.\d+)?)%/)[1]);
                            } else {
                                // Fallback
                                pct = m.status === 'pass' ? 100 : (m.status === 'fail' ? 15 : 50);
                            }
                            if (isNaN(pct)) pct = 0;
                            pct = Math.min(100, Math.max(0, pct));

                            return `
                            <div style="padding:6px 0; border-bottom:1px solid #222;">
                                <!-- Labels Row -->
                                <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:4px;">
                                    <div style="color:${statusColor}; font-weight:bold; font-size:12px;">
                                        ${m.value || '‚Äî'}${weightBadge}
                                    </div>
                                    <div style="color:#888; font-size:10px; text-align:right; max-width:60%;">
                                        ${m.requirement || m.req || 'Goal'}
                                    </div>
                                </div>
                                
                                <!-- Scale Bar -->
                                <div style="height:6px; background:#222; border-radius:3px; position:relative; overflow:hidden;">
                                    <div style="width:${pct}%; height:100%; background:${statusColor}; transition:width 0.5s ease-out; box-shadow:0 0 5px ${statusColor}44;"></div>
                                </div>
                            </div>
                        `;
                        }).join('');
                    } else {
                        // Fallback: simple string array - pair with requirements if available
                        if (node.requirements && node.requirements.length > 0) {
                            metricsHtml = node.requirements.map((req, i) => `
                                <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
                                    <span style="color:#9b59b6;">${req}</span>
                                    <span style="color:#f39c12; font-weight:bold;">${node.metrics[i] || '‚Äî'}</span>
                                </div>
                            `).join('');
                        } else {
                            metricsHtml = node.metrics.map(m => `<div style="padding:2px 0;">‚Ä¢ ${m}</div>`).join('');
                        }
                    }
                }
                document.getElementById('db-metrics').innerHTML = metricsHtml;

                // Tasks (subtasks)
                const subtasksHtml = node.subtasks && node.subtasks.length > 0 ? node.subtasks.map(s => `
                    <div style="border-bottom:1px solid #222; padding:4px 0;">
                        <div style="font-weight:bold; color:#fff; font-size:10px;">‚û¢ ${s.title}</div>
                        <div style="font-size:9px; color:#888; margin-top:2px;">${s.logic}</div>
                    </div>
                `).join('') : '<div style="color:#666; font-style:italic; font-size:10px;">No tasks defined.</div>';
                document.getElementById('db-subtasks').innerHTML = subtasksHtml;

                // Status & Owner
                document.getElementById('db-status').innerText = node.status ? node.status.toUpperCase() : 'UNKNOWN';
                document.getElementById('db-status').style.color = node.status === 'blocked' ? '#ff4444' : '#00ffcc';
                document.getElementById('db-owner').innerText = agentName;

                // Inputs (badge style)
                const inputsHtml = node.inputs && node.inputs.length > 0 ? node.inputs.map(i => `
                    <span style="background:#3498db22; color:#3498db; padding:3px 6px; border-radius:3px; font-size:9px;">${i}</span>
                `).join('') : '<span style="color:#666; font-style:italic; font-size:9px;">None</span>';
                document.getElementById('db-inputs').innerHTML = inputsHtml;

                // Outputs (badge style)
                const outputsHtml = node.outputs && node.outputs.length > 0 ? node.outputs.map(o => `
                    <span style="background:#2ecc7122; color:#2ecc71; padding:3px 6px; border-radius:3px; font-size:9px;">${o}</span>
                `).join('') : '<span style="color:#666; font-style:italic; font-size:9px;">None</span>';
                document.getElementById('db-outputs').innerHTML = outputsHtml;

                // Test Cases (renamed from Timeline) - show as test cases with pass/fail/pending and weights
                let testCasesHtml = '<div style="color:#666; font-style:italic;">No test cases defined.</div>';
                if (node.testCases && node.testCases.length > 0) {
                    // Show score breakdown header
                    testCasesHtml = `
                        <div style="display:flex; justify-content:space-between; padding:4px 8px; margin-bottom:8px; background:#1a1f25; border-radius:4px;">
                            <span style="color:#1abc9c; font-size:9px;">TEST SCORE: ${score.testsScore}%</span>
                            <span style="color:#888; font-size:9px;">Weight: 40%</span>
                        </div>
                    `;
                    testCasesHtml += node.testCases.map(tc => {
                        const weight = tc.weight || 1;
                        const weightBadge = weight > 1 ? `<span style="background:#1abc9c22; color:#1abc9c; font-size:8px; padding:1px 4px; border-radius:2px; margin-left:4px;">√ó${weight}</span>` : '';
                        const statusIcon = tc.status === 'pass' ? '‚úì' : tc.status === 'fail' ? '‚úó' : '‚óã';
                        const statusColor = tc.status === 'pass' ? '#2ecc71' : tc.status === 'fail' ? '#e74c3c' : '#888';
                        const bgColor = tc.status === 'pass' ? '#2ecc7111' : tc.status === 'fail' ? '#e74c3c11' : 'transparent';
                        return `
                            <div style="display:flex; align-items:center; padding:4px 6px; margin-bottom:3px; background:${bgColor}; border-radius:3px;">
                                <span style="color:${statusColor}; font-weight:bold; margin-right:8px; font-size:12px;">${statusIcon}</span>
                                <span style="flex:1; color:${tc.status === 'pass' ? '#888' : '#ccc'}; ${tc.status === 'pass' ? 'text-decoration:line-through;' : ''}">${tc.name}${weightBadge}</span>
                                ${tc.value ? `<span style="color:#888; font-size:9px; margin-left:8px;">${tc.value}</span>` : ''}
                            </div>
                        `;
                    }).join('');
                } else if (node.timeline && node.timeline.length > 0) {
                    // Fallback to timeline format for backward compatibility
                    testCasesHtml = node.timeline.map((t, i) => `
                        <div style="display:flex; align-items:center; margin-bottom:4px;">
                            <div style="width:14px; height:14px; border-radius:50%; background:${t.done ? '#2ecc71' : '#333'}; display:flex; align-items:center; justify-content:center; font-size:8px; margin-right:6px; color:#fff;">
                                ${t.done ? '‚úì' : i + 1}</div>
                            <div style="font-size:9px; color:${t.done ? '#888' : '#ccc'}; ${t.done ? 'text-decoration:line-through;' : ''}">
                                ${t.phase}</div>
                        </div>
                    `).join('');
                }
                document.getElementById('db-timeline').innerHTML = testCasesHtml;

                // Files
                let fileHtml = '<span style="color:#666; font-style:italic">No files.</span>';
                if (node.files && node.files.length > 0) {
                    fileHtml = UI.renderFileTree(node.files);
                }
                const fileFormHtml = `
                    <form class="file-attach-form" onsubmit="window.addFilePathToNode(event, '${node.id}')">
                        <input name="filePath" class="file-attach-input" placeholder="Add file path..." autocomplete="off" />
                        <button type="submit" class="file-attach-button">Attach</button>
                    </form>
                    <div class="file-attach-hint">Use repo-relative paths.</div>
                `;
                document.getElementById('db-files').innerHTML = fileHtml + fileFormHtml;

                document.getElementById('full-dashboard-overlay').style.display = 'flex';
            },

            renderGraph: () => {
                const container = document.getElementById('graph-nodes');
                const content = document.getElementById('graph-content');

                // Apply Pan
                content.style.transform = `translate(${State.graphPan.x}px, ${State.graphPan.y}px)`;

                // Render Nodes
                const highlightedIds = new Set((State.fileSearch.matches || []).map(m => m.node.id));
                container.innerHTML = State.graphNodes.map(n => {
                    const agent = State.agents.find(a => a.id === n.agentId);
                    const badge = agent ? `<div class="node-agent">${agent.initials}</div>` : '';
                    const isSelected = document.getElementById('detail-panel').style.display === 'block' &&
                        document.getElementById('panel-title').innerText === 'COMPONENT DETAIL' &&
                        document.querySelector('.prop-val').innerText === n.label; // Simple check
                    const isSearchHit = highlightedIds.has(n.id);

                    return `
        <div class="node ${n.type || ''} ${isSelected ? 'selected' : ''} ${isSearchHit ? 'search-hit' : ''}" style="left:${n.x}px; top:${n.y}px"
            onmousedown="window.graphDragStart(event, '${n.id}')" onclick="window.selectGraphNode('${n.id}')"
            ondblclick="window.UI.showDetailedModal('${n.id}')">
            <span class="node-label">${n.label}</span>
            <span class="node-status">${n.status}</span>
            ${badge}
        </div>
        `;
                }).join('');

                UI.updateConnections();
            },

            updateConnections: () => {
                const svg = document.getElementById('graph-svg');
                let svgHtml = '';

                State.graphEdges.forEach((edge, index) => {
                    const n1 = State.graphNodes.find(n => n.id === edge.from);
                    const n2 = State.graphNodes.find(n => n.id === edge.to);

                    if (n1 && n2) {
                        const x1 = n1.x + 70, y1 = n1.y + 50;
                        const x2 = n2.x + 70, y2 = n2.y;

                        // Bezier
                        const cp1x = x1;
                        const cp1y = y1 + 50;
                        const cp2x = x2;
                        const cp2y = y2 - 50;

                        let color = '#444';
                        if (edge.type === 'schema') color = 'var(--color-schema)';
                        if (edge.type === 'auth') color = 'var(--color-auth)';
                        if (edge.type === 'api') color = 'var(--color-api)';
                        if (edge.type === 'data') color = 'var(--color-data)';
                        if (edge.type === 'log') color = 'var(--color-log)';

                        svgHtml += `
        <path class="edge" d="M ${x1} ${y1} C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${x2} ${y2}" stroke="${color}" />`;

                        // Label Midpoint
                        const t = 0.5;
                        const mx = Math.pow(1 - t, 3) * x1 + 3 * Math.pow(1 - t, 2) * t * cp1x + 3 * (1 - t) * Math.pow(t, 2) * cp2x +
                            Math.pow(t, 3) * x2;
                        const my = Math.pow(1 - t, 3) * y1 + 3 * Math.pow(1 - t, 2) * t * cp1y + 3 * (1 - t) * Math.pow(t, 2) * cp2y +
                            Math.pow(t, 3) * y2;

                        const textWidth = edge.label.length * 6 + 10;

                        svgHtml += `
        <g class="edge-label-group" onclick="window.selectFileConnection(${index})">
            <rect x="${mx - textWidth / 2}" y="${my - 10}" width="${textWidth}" height="20" rx="4" fill="#0b0d10"
                stroke="${color}" class="edge-label-bg" />
            <text x="${mx}" y="${my + 4}" font-family="monospace" font-size="10" fill="${color}" text-anchor="middle"
                class="edge-label-text">${edge.label}</text>
        </g>
        `;
                    }
                });
                svg.innerHTML = svgHtml;
            },

            openComponentPanel: (node) => {
                const p = document.getElementById('detail-panel');
                const b = document.getElementById('panel-body');
                document.getElementById('panel-title').innerText = 'COMPONENT DETAIL';
                p.style.display = 'block';

                const agent = State.agents.find(a => a.id === node.agentId);
                const agentName = agent ? agent.name : 'Unassigned';

                const subtasksHtml = node.subtasks.length > 0 ? node.subtasks.map(s => `
        <div class="subtask-item">
            <div style="font-weight:bold; color:#fff">${s.title}</div>
            <div style="font-size:10px; color:#888; margin-top:2px;">${s.logic}</div>
        </div>
        `).join('') : '<div style="color:#666; font-style:italic">No subtasks</div>';

                const renderFileTree = (items, depth = 0) => {
                    let html = '';
                    items.forEach(item => {
                        const p = depth * 10;
                        const icon = item.type === 'folder' ? 'üìÅ' : 'üìÑ';
                        const cls = item.type === 'folder' ? 'ft-folder' : 'ft-file';
                        html += `<div class="ft-item" style="padding-left:${p}px"><span class="${cls}">${icon} ${item.name}</span></div>
        `;
                        if (item.children) html += renderFileTree(item.children, depth + 1);
                    });
                    return html;
                }

                const fileTreeHtml = node.files.length > 0 ? `<div class="file-tree-container">${renderFileTree(node.files)}
        </div>` : '<div style="color:#666">No files</div>';

                b.innerHTML = `
        <div class="prop-row"><span class="prop-label">Component</span><span class="prop-val">${node.label}</span></div>
        <div class="prop-row"><span class="prop-label">Status</span><span class="prop-val"
                style="color:${node.status === 'blocked' ? '#ff4444' : '#00ffcc'}">${node.status.toUpperCase()}</span>
        </div>
        <div class="prop-row"><span class="prop-label">Owner</span><span class="prop-val">${agentName}</span></div>

        <div style="margin-top:15px; padding-top:10px; border-top:1px solid #333;">
            <div class="prop-label" style="margin-bottom:5px; color:#fff">FILE STRUCTURE</div>
            ${fileTreeHtml}
        </div>

        <div style="margin-top:10px; padding-top:10px; border-top:1px solid #333;">
            <div class="prop-label" style="margin-bottom:5px; color:#fff">SUBTASKS</div>
            <div class="subtask-list">${subtasksHtml}</div>
        </div>

        <button class="btn-gen" onclick="alert('Agent dispatched!')">‚ú® Auto-Generate Tasks</button>
        `;
            },

            openFilePanel: (edge) => {
                const p = document.getElementById('detail-panel');
                const b = document.getElementById('panel-body');
                document.getElementById('panel-title').innerText = 'DATA ARTIFACT';
                p.style.display = 'block';

                // Mock Content generator (simplified)
                let content = "// Binary data or unknown format";
                if (edge.type === 'schema') content = `{\n "$schema": "http://json-schema.org/draft-07/schema",\n "type":
        "object"\n}`;
                if (edge.type === 'auth') content = `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`;

                let color = '#fff';
                if (edge.type === 'schema') color = 'var(--color-schema)';
                if (edge.type === 'auth') color = 'var(--color-auth)';

                b.innerHTML = `
        <div class="prop-row"><span class="prop-label">Filename</span><span class="prop-val"
                style="color:${color}">${edge.label}</span></div>
        <div class="prop-row"><span class="prop-label">Type</span><span
                class="prop-val">${edge.type.toUpperCase()}</span></div>

        <div style="margin: 15px 0; border-top: 1px solid #333; padding-top:10px;">
            <div style="color:#888; font-size:10px; text-transform:uppercase; margin-bottom:5px;">Description</div>
            <div style="font-size:12px; color:#ccc; margin-bottom: 15px;">${edge.description}</div>

            <div style="color:#888; font-size:10px; text-transform:uppercase; margin-bottom:5px;">Preview</div>
            <div class="file-preview">${content}</div>
        </div>
        `;
            },

            closePanel: () => {
                document.getElementById('detail-panel').style.display = 'none';
            },

            initFileSearch: () => {
                const input = document.getElementById('file-search-input');
                if (!input) return;
                input.addEventListener('input', (e) => {
                    UI.updateFileSearchResults(e.target.value || '');
                });
            },

            updateFileSearchResults: (query) => {
                const resultsContainer = document.getElementById('file-search-results');
                const normalizedQuery = query.trim().toLowerCase();
                State.fileSearch.query = normalizedQuery;

                if (!normalizedQuery) {
                    State.fileSearch.matches = [];
                    if (resultsContainer) {
                        resultsContainer.innerHTML = '<div style="padding:8px 0; color:#666; font-size:10px;">Type a file name to see linked goals.</div>';
                    }
                    UI.renderGraph();
                    return;
                }

                const matches = [];
                State.graphNodes.forEach(node => {
                    if (!node.files || node.files.length === 0) return;
                    node.files.forEach(file => {
                        const filePath = (file.path || file.name || '').toString();
                        if (!filePath) return;
                        if (filePath.toLowerCase().includes(normalizedQuery)) {
                            matches.push({
                                node,
                                filePath,
                                fileLabel: file.name || file.path || filePath
                            });
                        }
                    });
                });

                State.fileSearch.matches = matches;

                if (resultsContainer) {
                    if (matches.length === 0) {
                        resultsContainer.innerHTML = '<div style="padding:8px 0; color:#666; font-size:10px;">No matches in the current view.</div>';
                    } else {
                        resultsContainer.innerHTML = matches.map((match, idx) => `
                        <div class="file-search-row" onclick="window.focusFileSearchResult(${idx})">
                            <div class="file-search-path">${match.filePath}</div>
                            <div class="file-search-goal">Goal: ${match.node.label}</div>
                            <div class="file-search-meta">Node ID: ${match.node.id}</div>
                        </div>
                    `).join('');
                    }
                }

                UI.renderGraph();
            },

            focusNode: (nodeId) => {
                const node = State.graphNodes.find(n => n.id === nodeId);
                if (!node) return;

                const container = document.getElementById('view-graph');
                if (container) {
                    const rect = container.getBoundingClientRect();
                    const nodeCenterX = node.x + 70;
                    const nodeCenterY = node.y + 50;
                    State.graphPan.x = (rect.width / 2) - nodeCenterX;
                    State.graphPan.y = (rect.height / 2) - nodeCenterY;
                    container.style.backgroundPosition = `${State.graphPan.x}px ${State.graphPan.y}px`;
                }

                State.fileSearch.selectedNodeId = nodeId;
                UI.renderGraph();
                UI.openComponentPanel(node);
            }
        };

        // --- Interaction ---
        window.openFile = async (path) => {
            if (!path) return;
            console.log("Opening file:", path);
            try {
                const res = await fetch(`/open?path=${encodeURIComponent(path)}`);
                const data = await res.json();
                if (data.status === 'success') {
                    console.log("File opened successfully");
                } else {
                    alert("Error opening file: " + data.message);
                }
            } catch (e) {
                console.error("Request failed", e);
                alert("Failed to communicate with local server.");
            }
        };

        window.addFilePathToNode = (event, nodeId) => {
            event.preventDefault();
            const form = event.currentTarget;
            const input = form.querySelector('input[name="filePath"]');
            const filePath = input ? input.value.trim() : '';
            if (!filePath) return;

            const node = State.graphNodes.find(n => n.id === nodeId);
            if (!node) return;
            if (!node.files) node.files = [];

            const alreadyLinked = node.files.some(f => (f.path || f.name) === filePath);
            if (!alreadyLinked) {
                node.files.push({ name: filePath, path: filePath, type: 'file' });
            }

            if (input) input.value = '';

            const detailPanel = document.getElementById('detail-panel');
            if (detailPanel && detailPanel.style.display === 'block') {
                UI.openComponentPanel(node);
            }

            const dashboard = document.getElementById('full-dashboard-overlay');
            if (dashboard && dashboard.style.display === 'flex') {
                UI.showDetailedModal(node.id);
            }

            if (State.fileSearch.query) {
                UI.updateFileSearchResults(State.fileSearch.query);
            }
        };

        window.graphDragStart = (e, id) => {
            if (e.button !== 0) return;
            e.stopPropagation();
            dragNodeId = id;
            const node = State.graphNodes.find(n => n.id === id);
            const container = document.getElementById('view-graph').getBoundingClientRect();
            dragOffset.x = (e.clientX - container.left - State.graphPan.x) - node.x;
            dragOffset.y = (e.clientY - container.top - State.graphPan.y) - node.y;
        };

        window.selectGraphNode = (id) => {
            const node = State.graphNodes.find(n => n.id === id);
            if (node) UI.openComponentPanel(node);
            window.event.stopPropagation();
        };

        window.focusFileSearchResult = (index) => {
            const match = State.fileSearch.matches[index];
            if (match && match.node) {
                UI.focusNode(match.node.id);
            }
        };

        window.selectFileConnection = (index) => {
            const edge = State.graphEdges[index];
            if (edge) UI.openFilePanel(edge);
            window.event.stopPropagation();
        };

        window.UI = UI; // Expose

        // Update helper to use path
        UI.renderFileTree = (items, depth = 0) => {
            let html = '';
            items.forEach(item => {
                const p = depth * 10;
                const icon = item.type === 'folder' ? 'üìÅ' : 'üìÑ';
                const cls = item.type === 'folder' ? 'ft-folder' : 'ft-file';

                let clickAttr = '';
                if (item.type === 'file') {
                    // Use explicit path if available, else name (assumes root)
                    const filePath = escapeSingleQuotes(item.path || item.name);
                    clickAttr = `onclick="window.openFile('${filePath}')" style="cursor:pointer; text-decoration:underline;"`;
                }

                html += `<div class="ft-item" style="padding-left:${p}px" ${clickAttr}><span class="${cls}">${icon}
                ${item.name}</span></div>`;
                if (item.children) html += UI.renderFileTree(item.children, depth + 1);
            });
            return html;
        };

        // Redefine openComponentPanel to use new render
        UI.openComponentPanel = (node) => {
            const p = document.getElementById('detail-panel');
            const b = document.getElementById('panel-body');
            document.getElementById('panel-title').innerText = 'COMPONENT DETAIL';
            p.style.display = 'block';

            const agent = State.agents.find(a => a.id === node.agentId);
            const agentName = agent ? agent.name : 'Unassigned';

            const subtasksHtml = node.subtasks.length > 0 ? node.subtasks.map(s => `
        <div class="subtask-item">
            <div style="font-weight:bold; color:#fff">${s.title}</div>
            <div style="font-size:10px; color:#888; margin-top:2px;">${s.logic}</div>
        </div>
        `).join('') : '<div style="color:#666; font-style:italic">No subtasks</div>';

            const fileTreeHtml = node.files.length > 0 ? `<div class="file-tree-container">${UI.renderFileTree(node.files)}
        </div>` : '<div style="color:#666">No files</div>';
            const fileFormHtml = `
        <form class="file-attach-form" onsubmit="window.addFilePathToNode(event, '${node.id}')">
            <input name="filePath" class="file-attach-input" placeholder="Add file path..." autocomplete="off" />
            <button type="submit" class="file-attach-button">Attach</button>
        </form>
        <div class="file-attach-hint">Use repo-relative paths.</div>
        `;

            // Add Open Button if node itself represents a file (Level 2)
            let openBtn = '';
            // Heuristic: if label ends in .js or .csv, it's a file
            if (node.label.includes('.') && !node.label.includes(' ')) {
                const fPath = escapeSingleQuotes(node.path || node.label);
                openBtn = `<button class="btn-gen" style="background:var(--accent-warn); margin-bottom:10px;"
            onclick="window.openFile('${fPath}')">Open ${node.label}</button>`;
            }

            b.innerHTML = `
        <div class="prop-row"><span class="prop-label">Component</span><span class="prop-val">${node.label}</span></div>
        <div class="prop-row"><span class="prop-label">Status</span><span class="prop-val"
                style="color:${node.status === 'blocked' ? '#ff4444' : '#00ffcc'}">${node.status.toUpperCase()}</span>
        </div>
        <div class="prop-row"><span class="prop-label">Owner</span><span class="prop-val">${agentName}</span></div>

        ${openBtn}

        <div style="margin-top:15px; padding-top:10px; border-top:1px solid #333;">
            <div class="prop-label" style="margin-bottom:5px; color:#fff">FILE STRUCTURE</div>
            ${fileTreeHtml}
            ${fileFormHtml}
        </div>

        <div style="margin-top:10px; padding-top:10px; border-top:1px solid #333;">
            <div class="prop-label" style="margin-bottom:5px; color:#fff">SUBTASKS</div>
            <div class="subtask-list">${subtasksHtml}</div>
        </div>

        <button class="btn-gen" onclick="alert('Agent dispatched!')">‚ú® Auto-Generate Tasks</button>
        `;
        };
        window.addEventListener('mousedown', (e) => {
            if (!e.target.closest('.node') && !e.target.closest('#detail-panel') && !e.target.closest('.edge-label-group')) {
                isGraphPanning = true;
                panStart.x = e.clientX - State.graphPan.x;
                panStart.y = e.clientY - State.graphPan.y;
                document.getElementById('view-graph').style.cursor = 'grabbing';
            }
        });

        window.addEventListener('mousemove', (e) => {
            if (isGraphPanning) {
                State.graphPan.x = e.clientX - panStart.x;
                State.graphPan.y = e.clientY - panStart.y;
                document.getElementById('view-graph').style.backgroundPosition = `${State.graphPan.x}px ${State.graphPan.y}px`;
                UI.renderGraph();
                return;
            }

            if (dragNodeId) {
                const container = document.getElementById('view-graph').getBoundingClientRect();
                let newX = (e.clientX - container.left - State.graphPan.x) - dragOffset.x;
                let newY = (e.clientY - container.top - State.graphPan.y) - dragOffset.y;

                const node = State.graphNodes.find(n => n.id === dragNodeId);
                if (node) {
                    node.x = newX;
                    node.y = newY;
                    UI.renderGraph();
                }
            }
        });

        window.addEventListener('mouseup', () => {
            isGraphPanning = false;
            dragNodeId = null;
            document.getElementById('view-graph').style.cursor = 'grab';
        });

        // Start
        UI.init();

    </script>
</body>

</html>
